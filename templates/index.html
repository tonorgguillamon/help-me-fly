<!DOCTYPE html>
<html>
<head>
    <title>Help Me Fly - Chat Agent</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f7f7f7; }
        .chat-box { background: #fff; border-radius: 8px; padding: 1em; box-shadow: 0 2px 8px #ccc; max-width: 600px; margin: auto; }
        .message { margin-bottom: 1em; }
        .user { color: #0074D9; font-weight: bold; }
        .agent { color: #2ECC40; font-weight: bold; }
        .form-box { margin-top: 2em; }
        input[type="text"] { width: 80%; padding: 0.5em; border-radius: 4px; border: 1px solid #ccc; }
        input[type="submit"] { padding: 0.5em 1em; border-radius: 4px; border: none; background: #0074D9; color: #fff; cursor: pointer; }
    </style>
</head>
<body>
    <div class="chat-box">
        <h2>Help Me Fly - Chat Agent</h2>
        <div id="history"></div>
        <form class="form-box" id="chatForm">
            <input type="text" id="userQuery" name="userQuery" placeholder="Type your trip request..." required>
            <input type="submit" value="Send">
        </form>
    </div>

    <script>
        const form = document.getElementById("chatForm");
        const historyDiv = document.getElementById("history");
        let ws;

        function openWebSocket() {
            ws = new WebSocket("ws://" + window.location.host + "/ws/plan-trip");

            ws.onopen = () => {
                console.log("WebSocket connected");
            };

            ws.onmessage = (event) => {
                const data = event.data;

                if (data === "[DONE]") {
                    appendMessage("Agent", "--- End of plan ---");
                    ws.close();
                    return;
                }

                try {
                    const obj = JSON.parse(data);
                    appendMessage("Agent", JSON.stringify(obj, null, 2));
                } catch {
                    appendMessage("Agent", data);
                }
            };

            ws.onclose = () => { // event triggered by backend
                console.log("WebSocket closed. Reconnecting...");
                setTimeout(openWebSocket, 500);
            };
            ws.onerror = (err) => {
                appendMessage("Agent", "WebSocket error: " + err);
            };
        }

        form.addEventListener("submit", function(event) {
            event.preventDefault();
            const query = document.getElementById("userQuery").value;
            appendMessage("You", query);

            // Always send JSON object with userQuery
            ws.send(JSON.stringify({ userQuery: query }));

            document.getElementById("userQuery").value = "";
        });

        openWebSocket();

        function appendMessage(sender, text) {
            const div = document.createElement("div");
            div.classList.add("message");

            const senderSpan = document.createElement("span");
            senderSpan.className = sender === "You" ? "user" : "agent";
            senderSpan.textContent = sender + ":";

            const textPre = document.createElement("pre");
            textPre.style.whiteSpace = "pre-wrap"; // preserves \n and spaces
            textPre.textContent = text;

            div.appendChild(senderSpan);
            div.appendChild(document.createTextNode(" ")); // optional space
            div.appendChild(textPre);

            historyDiv.appendChild(div);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }
    </script>
</body>
</html>
